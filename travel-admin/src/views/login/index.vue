<template>
  <div class="login-page">
    <!-- å·¦ä¾§æ•°æ®ä»ªè¡¨æ¿ -->
    <div class="dashboard-section">
      <div class="dashboard-content">
        <!-- é¡¶éƒ¨æ ‡ç­¾ -->
        <div class="dashboard-tag">ZHLY â€¢ SMART JOURNEY OS</div>
        
        <!-- ä¸»æ ‡é¢˜ -->
        <h1 class="dashboard-title">Monochrome Mobility Intelligence</h1>
        
        <!-- æè¿°æ–‡å­— -->
        <p class="dashboard-description">
          å•è‰²ç°è°ƒæƒ…ç»ªæ¿ï¼Œå±•ç¤ºå®æ—¶æ—…æœæ€åŠ¿ä¸å…³é”®æŒ‡æ ‡ã€‚çº¯ç²¹ã€å…‹åˆ¶ï¼Œå¸¦æœ‰å®‰å…¨æ„Ÿï¼Œè®©æ—…æœæ•°æ®åœ¨æ­¤æ²‰æ·€å¹¶åšå‡ºå†³ç­–ã€‚
        </p>
        
        <!-- å…³é”®æŒ‡æ ‡å¡ç‰‡ -->
        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-label">Active Travelers</div>
            <div class="metric-value">12.8K</div>
            <div class="metric-change positive">+18%</div>
          </div>
          
          <div class="metric-card">
            <div class="metric-label">AI è¡Œç¨‹ç”Ÿæˆ</div>
            <div class="metric-value">3.1s</div>
            <div class="metric-change negative">-0.8s</div>
          </div>
          
          <div class="metric-card">
            <div class="metric-label">å®æ—¶å‘Šè­¦</div>
            <div class="metric-value">0</div>
            <div class="metric-status">Secured</div>
          </div>
          
          <div class="metric-card">
            <div class="metric-label">ç³»ç»Ÿå¯ç”¨ç‡</div>
            <div class="metric-value">99.97%</div>
            <div class="metric-change positive">+0.2%</div>
          </div>
        </div>
        
        <!-- å®æ—¶æ—…æœæ€åŠ¿ -->
        <div class="status-card">
          <div class="status-header">
            <span class="status-title">å®æ—¶æ—…æœæ€åŠ¿</span>
            <span class="live-badge">LIVE</span>
          </div>
          <div class="status-list">
            <div class="status-item">é‡åº† â€¢ å±±åŸå¤œèˆª308æ¡ç›´æ’­è·¯çº¿</div>
            <div class="status-item">åŒ—äº¬ â€¢ èƒ¡åŒæ¼«æ¸¸ 98æ¡ç‰¹è‰²çº¿è·¯</div>
            <div class="status-item">æˆéƒ½ â€¢ ç¾é£Ÿå·¡èˆª142å®¶ç­¾çº¦å•†æˆ·</div>
          </div>
        </div>
        
        <!-- ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ -->
        <div class="status-card">
          <div class="status-header">
            <span class="status-title">ç³»ç»Ÿè¿è¡ŒçŠ¶æ€</span>
            <span class="online-badge">ONLINE</span>
          </div>
          <div class="status-list">
            <div class="status-item">API å“åº”æ—¶é—´: <span class="status-value">12ms</span></div>
            <div class="status-item">æ•°æ®åº“è¿æ¥: <span class="status-value">æ­£å¸¸</span></div>
            <div class="status-item">ç¼“å­˜å‘½ä¸­ç‡: <span class="status-value">94.2%</span></div>
          </div>
        </div>
        
        <!-- åº•éƒ¨æ ‡ç­¾ -->
        <div class="dashboard-footer">
          <span class="footer-tag">Zero Downtime</span>
          <span class="footer-tag">AI Copilot</span>
          <span class="footer-tag">SOC2 Ready</span>
        </div>
      </div>
    </div>
    
    <!-- å³ä¾§ç™»å½•è¡¨å• -->
    <div class="login-section">
      <div class="login-content">
        <!-- é¡¶éƒ¨å›¾æ ‡å’Œæ ‡é¢˜ -->
        <div class="login-header">
          <div class="logo-cube">
            <div class="cube-face front"></div>
            <div class="cube-face back"></div>
            <div class="cube-face right"></div>
            <div class="cube-face left"></div>
            <div class="cube-face top"></div>
            <div class="cube-face bottom"></div>
          </div>
          <div class="header-tag">UNIFIED CONTROL â€¢ MISSION SAFE</div>
          <h1 class="login-title">æ™ºæ…§ç”Ÿæ€æ—…æ¸¸å¹³å°</h1>
        </div>
        
        <!-- ç”¨æˆ·/ç®¡ç†ç«¯åˆ‡æ¢ -->
        <div class="login-type-selector">
          <div class="selector-wrapper">
            <div 
              class="selector-option" 
              :class="{ active: loginType === 'user' }"
              @click="loginType = 'user'; handleLoginTypeChange('user')"
            >
              <el-icon class="option-icon"><User /></el-icon>
              <span class="option-text">ç”¨æˆ·ç«¯</span>
            </div>
            <div 
              class="selector-option" 
              :class="{ active: loginType === 'admin' }"
              @click="loginType = 'admin'; handleLoginTypeChange('admin')"
            >
              <el-icon class="option-icon"><Setting /></el-icon>
              <span class="option-text">ç®¡ç†ç«¯</span>
            </div>
            <div class="selector-slider" :class="{ 'slide-right': loginType === 'admin' }"></div>
          </div>
        </div>
        
        <!-- ç™»å½•æ–¹å¼åˆ‡æ¢ -->
        <div class="login-method-tabs">
          <div 
            class="tab-item" 
            :class="{ active: loginMethod === 'account' }"
            @click="loginMethod = 'account'"
          >
            è´¦å·ç™»å½•
          </div>
          <div 
            class="tab-item" 
            :class="{ active: loginMethod === 'phone' }"
            @click="loginMethod = 'phone'"
          >
            æ‰‹æœºç™»å½•
          </div>
        </div>

        <!-- è´¦å·å¯†ç ç™»å½•è¡¨å• -->
        <el-form 
          v-if="loginMethod === 'account'"
          :model="loginForm" 
          :rules="loginRules" 
          ref="loginFormRef" 
          class="login-form"
        >
          <el-form-item prop="username">
            <el-input 
              v-model="loginForm.username" 
              placeholder="ç”¨æˆ·å/é‚®ç®±"
              prefix-icon="User"
              size="large"
            />
          </el-form-item>
          
          <el-form-item prop="password">
            <el-input 
              v-model="loginForm.password" 
              type="password" 
              placeholder="å¯†ç "
              prefix-icon="Lock"
              size="large"
              @keyup.enter="handleLogin"
            />
          </el-form-item>
          
          <el-form-item class="login-options">
            <div class="options-container">
              <el-checkbox v-model="rememberMe">ä¿æŒä¼šè¯</el-checkbox>
              <el-link type="primary" class="forgot-password" @click="handleForgotPassword">å¿˜è®°å¯†ç ?</el-link>
            </div>
          </el-form-item>
          
          <el-form-item>
            <el-button 
              type="primary" 
              @click="handleLogin" 
              :loading="loading"
              size="large"
              class="login-button"
            >
              {{ loading ? 'ç™»å½•ä¸­...' : 'è¿›å…¥æ§åˆ¶å°' }}
            </el-button>
          </el-form-item>
        </el-form>

        <!-- æ‰‹æœºå·éªŒè¯ç ç™»å½•è¡¨å• -->
        <el-form 
          v-if="loginMethod === 'phone'"
          :model="phoneLoginForm" 
          :rules="phoneLoginRules" 
          ref="phoneLoginFormRef" 
          class="login-form phone-login-form"
        >
          <el-form-item prop="phone">
            <el-input 
              v-model="phoneLoginForm.phone" 
              placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
              :prefix-icon="Phone"
              size="large"
            />
          </el-form-item>
          
          <el-form-item prop="captcha">
            <div class="captcha-input-wrapper">
              <el-input 
                v-model="phoneLoginForm.captcha" 
                placeholder="è¯·è¾“å…¥éªŒè¯ç "
                :prefix-icon="Message"
                size="large"
                @keyup.enter="handlePhoneLogin"
              />
              <el-button 
                :disabled="countdown > 0"
                @click="handleSendCaptcha"
                class="captcha-button"
              >
                {{ countdown > 0 ? `${countdown}ç§’åé‡å‘` : 'å‘é€éªŒè¯ç ' }}
              </el-button>
            </div>
          </el-form-item>
          
          <el-form-item>
            <el-button 
              type="primary" 
              @click="handlePhoneLogin" 
              :loading="loading"
              size="large"
              class="login-button"
            >
              {{ loading ? 'ç™»å½•ä¸­...' : 'è¿›å…¥æ§åˆ¶å°' }}
            </el-button>
          </el-form-item>
        </el-form>
        
        <!-- æ³¨å†Œé“¾æ¥ -->
        <div class="register-link">
          <el-link type="primary" @click="handleRegister" class="register-link-text">
            å°šæœªåŠ å…¥? åˆ›å»ºæ—…æœèº«ä»½
          </el-link>
        </div>
        
        <!-- åº•éƒ¨ä¿¡æ¯ -->
        <div class="login-footer">
          <div class="footer-info">
            <span class="info-label">å®‰å…¨ç­‰çº§:</span>
            <span class="info-value">Zero-Trust â€¢ MFA</span>
          </div>
          <div class="footer-info">
            <span class="info-label">ç³»ç»ŸçŠ¶æ€:</span>
            <span class="info-value status-green">All Systems Green</span>
          </div>
          <div class="footer-links">
            <el-link type="primary" @click="handleTerms">æœåŠ¡æ¡æ¬¾</el-link>
            <el-link type="primary" @click="handlePrivacy">éšç§å£°æ˜</el-link>
            <el-link type="primary" @click="handleAboutUs">å…³äºæˆ‘ä»¬</el-link>
            <el-link type="primary" @click="handleContact">è”ç³»æ”¯æŒ</el-link>
          </div>
        </div>
        
        <!-- å¯¹è¯æ¡†ç»„ä»¶ -->
        <AgreementDialog v-model="showUserAgreementDialog" type="user" />
        <AgreementDialog v-model="showPrivacyDialog" type="privacy" />
        
        <!-- å…³äºæˆ‘ä»¬å¯¹è¯æ¡† -->
        <el-dialog
          v-model="showAboutDialog"
          title="å…³äºæˆ‘ä»¬"
          width="500px"
          :close-on-click-modal="true"
        >
          <div class="about-content">
            <h3>{{ systemStore.userPlatformName || 'æ™ºæ…§ç”Ÿæ€æ—…æ¸¸ç³»ç»Ÿ' }}</h3>
            <p>{{ systemStore.footerDescription || 'æ™ºæ…§ç”Ÿæ€æ—…æ¸¸ç³»ç»Ÿæ˜¯ä¸€ä¸ªé›†æˆäº†äººå·¥æ™ºèƒ½ã€å¤§æ•°æ®åˆ†æå’Œç”Ÿæ€æ—…æ¸¸ç†å¿µçš„ç»¼åˆæ€§æ—…æ¸¸æœåŠ¡å¹³å°ã€‚' }}</p>
            <h4>æˆ‘ä»¬çš„ä½¿å‘½</h4>
            <p>é€šè¿‡ç§‘æŠ€èµ‹èƒ½ï¼Œä¸ºæ¸¸å®¢æä¾›ä¸ªæ€§åŒ–ã€æ™ºèƒ½åŒ–çš„æ—…æ¸¸æœåŠ¡ï¼ŒåŒæ—¶ä¿ƒè¿›ç”Ÿæ€æ—…æ¸¸çš„å¯æŒç»­å‘å±•ã€‚</p>
            <h4>æ ¸å¿ƒåŠŸèƒ½</h4>
            <ul>
              <li>æ™ºèƒ½æ—…æ¸¸è·¯çº¿è§„åˆ’</li>
              <li>ä¸ªæ€§åŒ–æ™¯ç‚¹æ¨è</li>
              <li>ç”Ÿæ€æ—…æ¸¸æ–‡åŒ–ä½“éªŒ</li>
              <li>å®æ—¶æ—…æ¸¸æ•°æ®ç›‘æ§</li>
            </ul>
            <h4>æŠ€æœ¯ç‰¹è‰²</h4>
            <p>é‡‡ç”¨å‰æ²¿çš„AIæŠ€æœ¯ã€å¤§æ•°æ®åˆ†æå’Œäº‘è®¡ç®—æ¶æ„ï¼Œä¸ºç”¨æˆ·æä¾›æµç•…ã€å®‰å…¨ã€æ™ºèƒ½çš„æ—…æ¸¸æœåŠ¡ä½“éªŒã€‚</p>
          </div>
        </el-dialog>
        
        <!-- è”ç³»æ”¯æŒå¯¹è¯æ¡† -->
        <el-dialog
          v-model="showContactDialog"
          title="è”ç³»æ”¯æŒ"
          width="500px"
          :close-on-click-modal="true"
        >
          <div class="contact-content">
            <h3>è·å–å¸®åŠ©</h3>
            <p>æˆ‘ä»¬éšæ—¶ä¸ºæ‚¨æä¾›æ”¯æŒæœåŠ¡ï¼Œå¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»æˆ‘ä»¬ï¼š</p>
            <div class="contact-item">
              <strong>ğŸ“§ é‚®ç®±æ”¯æŒï¼š</strong>
              <a :href="`mailto:${systemStore.contactEmail}`">{{ systemStore.contactEmail }}</a>
            </div>
            <div class="contact-item">
              <strong>ğŸ“ å®¢æœçƒ­çº¿ï¼š</strong>
              <span>{{ systemStore.contactPhone }}</span>
            </div>
            <div class="contact-item" v-if="systemStore.contactTime">
              <strong>ğŸ• æœåŠ¡æ—¶é—´ï¼š</strong>
              <span>{{ systemStore.contactTime }}</span>
            </div>
            <div class="contact-item">
              <strong>ğŸ’¬ åœ¨çº¿å®¢æœï¼š</strong>
              <span>ç™»å½•åå¯åœ¨ç³»ç»Ÿå†…è”ç³»åœ¨çº¿å®¢æœ</span>
            </div>
            <div class="contact-item">
              <strong>ğŸ“ å…¬å¸åœ°å€ï¼š</strong>
              <span>å¹¿è¥¿å£®æ—è‡ªæ²»åŒºå—å®å¸‚</span>
            </div>
          </div>
        </el-dialog>
      </div>
      
      <!-- èƒŒæ™¯è£…é¥° -->
      <div class="login-bg-decoration">
        <div class="bg-circle circle-1"></div>
        <div class="bg-circle circle-2"></div>
        <div class="bg-circle circle-3"></div>
        <div class="bg-grid"></div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, reactive, onMounted, onUnmounted, watch } from 'vue'
import { useRouter } from 'vue-router'
import { authAPI } from '@/api/auth'
import { useUserStore } from '@/stores/user'
import { useSystemStore } from '@/stores/system'
import { ElMessage } from 'element-plus'
import { User, Setting, Phone, Message } from '@element-plus/icons-vue'
import AgreementDialog from '@/components/AgreementDialog.vue'

const router = useRouter()
const systemStore = useSystemStore()

// ç™»å½•ç±»å‹é€‰æ‹©ï¼ˆç”¨æˆ·ç«¯/ç®¡ç†ç«¯ï¼‰
const loginType = ref('user')

// ç™»å½•æ–¹å¼é€‰æ‹©ï¼ˆè´¦å·ç™»å½•/æ‰‹æœºç™»å½•ï¼‰
const loginMethod = ref('account')

// è´¦å·ç™»å½•è¡¨å•æ•°æ®
const loginForm = reactive({
  username: '',
  password: ''
})

// æ‰‹æœºå·ç™»å½•è¡¨å•æ•°æ®
const phoneLoginForm = reactive({
  phone: '',
  captcha: ''
})

// ä¿æŒä¼šè¯
const rememberMe = ref(false)

// éªŒè¯ç å€’è®¡æ—¶
const countdown = ref(0)
let countdownTimer: NodeJS.Timeout | null = null

// é¡µé¢åŠ è½½æ—¶ï¼Œä»localStorageè¯»å–ä¿å­˜çš„è´¦å·å’Œå¯†ç ï¼Œå¹¶åŠ è½½ç³»ç»Ÿé…ç½®
onMounted(async () => {
  const savedUsername = localStorage.getItem('remembered_username')
  const savedPassword = localStorage.getItem('remembered_password')
  const savedRememberMe = localStorage.getItem('remember_me')
  
  if (savedUsername) {
    loginForm.username = savedUsername
  }
  if (savedPassword) {
    loginForm.password = savedPassword
  }
  if (savedRememberMe === 'true') {
    rememberMe.value = true
  }
  
  // åŠ è½½ç³»ç»Ÿé…ç½®
  await systemStore.fetchConfig()
})

// è¡¨å•éªŒè¯è§„åˆ™
const loginRules = {
  username: [],
  password: []
}

// æ‰‹æœºå·ç™»å½•éªŒè¯è§„åˆ™
const phoneLoginRules = {
  phone: [
    { required: true, message: 'è¯·è¾“å…¥æ‰‹æœºå·', trigger: 'blur' },
    {
      validator: (_rule: any, value: string, callback: Function) => {
        if (!value) {
          callback(new Error('è¯·è¾“å…¥æ‰‹æœºå·'))
        } else {
          // ç®€å•çš„æ‰‹æœºå·æ ¼å¼éªŒè¯ï¼ˆæ”¯æŒå›½é™…æ ¼å¼ï¼‰
          const phoneRegex = /^(\+?[1-9]\d{1,14}|1[3-9]\d{9})$/
          if (!phoneRegex.test(value.replace(/[\s-]/g, ''))) {
            callback(new Error('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·æ ¼å¼'))
          } else {
            callback()
          }
        }
      },
      trigger: 'blur'
    }
  ],
  captcha: [
    { required: true, message: 'è¯·è¾“å…¥éªŒè¯ç ', trigger: 'blur' },
    { pattern: /^\d{6}$/, message: 'éªŒè¯ç ä¸º6ä½æ•°å­—', trigger: 'blur' }
  ]
}

// è¡¨å•å¼•ç”¨
const loginFormRef = ref()
const phoneLoginFormRef = ref()
const loading = ref(false)

// å¯¹è¯æ¡†çŠ¶æ€
const showUserAgreementDialog = ref(false)
const showPrivacyDialog = ref(false)
const showAboutDialog = ref(false)
const showContactDialog = ref(false)

// ç™»å½•ç±»å‹åˆ‡æ¢
const handleLoginTypeChange = (value: string) => {
  loginForm.username = ''
  loginForm.password = ''
  phoneLoginForm.phone = ''
  phoneLoginForm.captcha = ''
  rememberMe.value = false
}

// å‘é€æ‰‹æœºéªŒè¯ç 
const handleSendCaptcha = async () => {
  if (!phoneLoginFormRef.value) return
  
  await phoneLoginFormRef.value.validateField('phone', async (valid: boolean) => {
    if (!valid) {
      return
    }
    
    try {
      loading.value = true
      const response = await authAPI.sendPhoneCaptcha({ phone: phoneLoginForm.phone })
      if (response.code === 200) {
        ElMessage.success('éªŒè¯ç å·²å‘é€ï¼Œè¯·æŸ¥æ”¶')
        // å¼€å§‹å€’è®¡æ—¶
        startCountdown()
      } else {
        ElMessage.error(response.message || 'å‘é€éªŒè¯ç å¤±è´¥')
      }
    } catch (error: any) {
      ElMessage.error(error.response?.data?.message || 'å‘é€éªŒè¯ç å¤±è´¥')
    } finally {
      loading.value = false
    }
  })
}

// å¼€å§‹å€’è®¡æ—¶
const startCountdown = () => {
  countdown.value = 60
  if (countdownTimer) {
    clearInterval(countdownTimer)
  }
  countdownTimer = setInterval(() => {
    countdown.value--
    if (countdown.value <= 0) {
      if (countdownTimer) {
        clearInterval(countdownTimer)
        countdownTimer = null
      }
    }
  }, 1000)
}

// æ‰‹æœºå·ç™»å½•
const handlePhoneLogin = async () => {
  if (!phoneLoginFormRef.value) return
  
  await phoneLoginFormRef.value.validate(async (valid: boolean, fields: any) => {
    if (!valid) {
      // éªŒè¯å¤±è´¥ï¼Œä½¿ç”¨ ElMessage æ˜¾ç¤ºç¬¬ä¸€ä¸ªé”™è¯¯
      const firstError = Object.keys(fields || {})[0]
      if (firstError && fields[firstError] && fields[firstError].length > 0) {
        ElMessage.error(fields[firstError][0].message)
      } else {
        ElMessage.error('è¯·æ£€æŸ¥è¾“å…¥ä¿¡æ¯')
      }
      return
    }
    
    try {
      loading.value = true
      const response = await authAPI.loginByPhone({
        phone: phoneLoginForm.phone,
        captcha: phoneLoginForm.captcha,
        loginType: loginType.value
      })
      
      if (response.code === 200) {
        localStorage.setItem('travel_token', response.data.token)
        localStorage.setItem('travel_user_info', JSON.stringify(response.data.user))
        
        const userStore = useUserStore()
        userStore.setToken(response.data.token)
        userStore.setUserInfo(response.data.user)
        
        ElMessage.success('ç™»å½•æˆåŠŸ')
        
        const user = response.data.user
        const role = user.role
        
        if (role === 1) {
          router.push('/home/admin/dashboard')
        } else if (role === 2) {
          router.push('/home/user/dashboard')
        } else {
          router.push('/home/user/dashboard')
        }
      } else {
        ElMessage.error(response.message || 'ç™»å½•å¤±è´¥')
      }
    } catch (error: any) {
      let errorMessage = 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•'
      
      if (error.response?.data?.message) {
        errorMessage = error.response.data.message
      } else if (error.message) {
        if (error.message.includes('æœªæ³¨å†Œ')) {
          errorMessage = 'è¯¥æ‰‹æœºå·æœªæ³¨å†Œï¼Œè¯·å…ˆæ³¨å†Œ'
        } else if (error.message.includes('éªŒè¯ç ')) {
          errorMessage = 'éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸï¼Œè¯·é‡æ–°è·å–'
        } else {
          errorMessage = error.message
        }
      }
      
      ElMessage.error(errorMessage)
    } finally {
      loading.value = false
    }
  })
}

// ç»„ä»¶å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
onMounted(() => {
  // ... existing code
})

watch(() => loginMethod.value, () => {
  // åˆ‡æ¢ç™»å½•æ–¹å¼æ—¶æ¸…ç©ºè¡¨å•
  phoneLoginForm.phone = ''
  phoneLoginForm.captcha = ''
  loginForm.username = ''
  loginForm.password = ''
  if (countdownTimer) {
    clearInterval(countdownTimer)
    countdownTimer = null
  }
  countdown.value = 0
})

// ç™»å½•å¤„ç†
const handleLogin = async () => {
  try {
    loading.value = true
    
    const response = await authAPI.login({
      username: loginForm.username,
      password: loginForm.password,
      loginType: loginType.value
    })
    
    if (response.code === 200) {
      localStorage.setItem('travel_token', response.data.token)
      localStorage.setItem('travel_user_info', JSON.stringify(response.data.user))
      
      if (rememberMe.value) {
        localStorage.setItem('remembered_username', loginForm.username)
        localStorage.setItem('remembered_password', loginForm.password)
        localStorage.setItem('remember_me', 'true')
      } else {
        localStorage.removeItem('remembered_username')
        localStorage.removeItem('remembered_password')
        localStorage.removeItem('remember_me')
      }
      
      const userStore = useUserStore()
      userStore.setToken(response.data.token)
      userStore.setUserInfo(response.data.user)
      
      ElMessage.success('ç™»å½•æˆåŠŸ')
      
      const user = response.data.user
      const role = user.role
      
      if (role === 1) {
        router.push('/home/admin/dashboard')
      } else if (role === 2) {
        router.push('/home/user/dashboard')
      } else {
        router.push('/home/user/dashboard')
      }
    } else {
      ElMessage.error(response.message || 'ç™»å½•å¤±è´¥')
    }
  } catch (error: any) {
    let errorMessage = 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•'
    
    if (error.response?.data?.message) {
      errorMessage = error.response.data.message
    } else if (error.response?.data?.data) {
      errorMessage = error.response.data.data
    } else if (error.message) {
      if (error.message.includes('selectOne') || 
          error.message.includes('TooManyResults') ||
          error.message.includes('Expected one result')) {
        errorMessage = 'è´¦å·ä¿¡æ¯å¼‚å¸¸ï¼Œè¯·è”ç³»ç®¡ç†å‘˜'
      } else if (error.message.includes('Connection') || 
                 error.message.includes('timeout')) {
        errorMessage = 'ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•'
      } else if (error.message.includes('500') || 
                 error.message.includes('Internal Server Error')) {
        errorMessage = 'æœåŠ¡å™¨å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•'
      } else {
        errorMessage = error.message
      }
    }
    
    ElMessage.error(errorMessage)
  } finally {
    loading.value = false
  }
}

// æ³¨å†Œå¤„ç†
const handleRegister = () => {
  router.push('/register')
}

// å¿˜è®°å¯†ç å¤„ç†
const handleForgotPassword = () => {
  router.push('/forgot-password')
}

// åº•éƒ¨é“¾æ¥å¤„ç†
const handleTerms = () => {
  showUserAgreementDialog.value = true
}

const handlePrivacy = () => {
  showPrivacyDialog.value = true
}

const handleAboutUs = () => {
  showAboutDialog.value = true
}

const handleContact = () => {
  showContactDialog.value = true
}

// ç»„ä»¶å¸è½½æ—¶æ¸…ç†å®šæ—¶å™¨
onUnmounted(() => {
  if (countdownTimer) {
    clearInterval(countdownTimer)
    countdownTimer = null
  }
})

// ç›‘å¬ç™»å½•æ–¹å¼åˆ‡æ¢ï¼Œæ¸…ç©ºè¡¨å•
watch(() => loginMethod.value, () => {
  phoneLoginForm.phone = ''
  phoneLoginForm.captcha = ''
  loginForm.username = ''
  loginForm.password = ''
  if (countdownTimer) {
    clearInterval(countdownTimer)
    countdownTimer = null
  }
  countdown.value = 0
})
</script>

<style lang="scss" scoped>
.login-page {
  height: 100vh;
  display: flex;
  overflow: hidden;
  background: #000000;
  position: relative;
}

// å·¦ä¾§æ•°æ®ä»ªè¡¨æ¿
.dashboard-section {
  flex: 0 0 50%;
  background: linear-gradient(to right, 
    #0a0a0a 0%, 
    #0a0a0a 70%, 
    rgba(10, 10, 10, 0.8) 85%,
    rgba(0, 0, 0, 0.4) 95%,
    transparent 100%);
  padding: 0 50px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  color: #ffffff;
  position: relative;
  overflow: hidden;
  
  .dashboard-content {
    max-width: 600px;
    margin: 0 auto;
    position: relative;
    z-index: 2;
    overflow-y: auto;
    max-height: 100vh;
    padding: 40px 0;
    
    // éšè—æ»šåŠ¨æ¡ä½†ä¿æŒæ»šåŠ¨åŠŸèƒ½
    &::-webkit-scrollbar {
      width: 0;
      background: transparent;
    }
  }
  
  .dashboard-tag {
    font-size: 12px;
    color: #888;
    letter-spacing: 2px;
    margin-bottom: 20px;
    text-transform: uppercase;
  }
  
  .dashboard-title {
    font-size: 48px;
    font-weight: 700;
    color: #ffffff;
    margin-bottom: 20px;
    line-height: 1.2;
  }
  
  .dashboard-description {
    font-size: 14px;
    color: #aaa;
    line-height: 1.8;
    margin-bottom: 40px;
  }
  
  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 30px;
    
    .metric-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      
      .metric-label {
        font-size: 12px;
        color: #888;
        margin-bottom: 8px;
      }
      
      .metric-value {
        font-size: 32px;
        font-weight: 700;
        color: #ffffff;
        margin-bottom: 8px;
      }
      
      .metric-change {
        font-size: 12px;
        font-weight: 600;
        
        &.positive {
          color: #4ade80;
        }
        
        &.negative {
          color: #f87171;
        }
      }
      
      .metric-status {
        font-size: 12px;
        color: #4ade80;
      }
    }
  }
  
  .status-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    
    .status-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      
      .status-title {
        font-size: 14px;
        font-weight: 600;
        color: #ffffff;
      }
      
      .live-badge {
        background: #ef4444;
        color: #ffffff;
        font-size: 10px;
        font-weight: 700;
        padding: 4px 8px;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      
      .online-badge {
        background: #4ade80;
        color: #000000;
        font-size: 10px;
        font-weight: 700;
        padding: 4px 8px;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
    }
    
    .status-list {
      .status-item {
        font-size: 13px;
        color: #aaa;
        margin-bottom: 8px;
        line-height: 1.6;
        
        .status-value {
          color: #ffffff;
          font-weight: 600;
        }
      }
    }
  }
  
  .dashboard-footer {
    display: flex;
    gap: 12px;
    margin-top: auto;
    padding-top: 40px;
    
    .footer-tag {
      font-size: 11px;
      color: #666;
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
    }
  }
}

// å³ä¾§ç™»å½•è¡¨å•
.login-section {
  flex: 0 0 50%;
  background: #000000;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 40px;
  overflow: hidden;
  
  .login-content {
    width: 100%;
    max-width: 420px;
    position: relative;
    z-index: 2;
  }
  
  .login-header {
    text-align: center;
    margin-bottom: 40px;
    
    .logo-cube {
      width: 60px;
      height: 60px;
      margin: 0 auto 20px;
      position: relative;
      transform-style: preserve-3d;
      animation: rotateCube 10s infinite linear;
      
      .cube-face {
        position: absolute;
        width: 60px;
        height: 60px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.05);
      }
      
      .front { transform: rotateY(0deg) translateZ(30px); }
      .back { transform: rotateY(180deg) translateZ(30px); }
      .right { transform: rotateY(90deg) translateZ(30px); }
      .left { transform: rotateY(-90deg) translateZ(30px); }
      .top { transform: rotateX(90deg) translateZ(30px); }
      .bottom { transform: rotateX(-90deg) translateZ(30px); }
    }
    
    .header-tag {
      font-size: 11px;
      color: #888;
      letter-spacing: 2px;
      margin-bottom: 12px;
      text-transform: uppercase;
    }
    
    .login-title {
      font-size: 32px;
      font-weight: 700;
      color: #ffffff;
    }
  }
  
  // ç™»å½•æ–¹å¼åˆ‡æ¢æ ‡ç­¾é¡µ
  .login-method-tabs {
    display: flex;
    gap: 12px;
    margin-bottom: 30px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 4px;
    
    .tab-item {
      flex: 1;
      text-align: center;
      padding: 10px 20px;
      color: #888;
      font-size: 14px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.3s ease;
      
      &:hover {
        color: #fff;
        background: rgba(255, 255, 255, 0.05);
      }
      
      &.active {
        color: #fff;
        background: rgba(255, 255, 255, 0.1);
        font-weight: 600;
      }
    }
  }

  .login-type-selector {
    margin-bottom: 40px;
    display: flex;
    justify-content: center;
    
    .selector-wrapper {
      position: relative;
      display: flex;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 14px;
      padding: 4px;
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
      gap: 4px;
      min-width: 280px;
      
      .selector-option {
        position: relative;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 20px;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 2;
        color: #666;
        font-size: 14px;
        font-weight: 500;
        
        .option-icon {
          font-size: 18px;
          transition: transform 0.3s ease;
          
          :deep(svg) {
            width: 18px;
            height: 18px;
          }
        }
        
        .option-text {
          transition: color 0.3s ease;
        }
        
        &.active {
          color: #ffffff;
          
        .option-icon {
          transform: scale(1.15);
        }
        
        .option-text {
          font-weight: 600;
        }
        }
      }
      
      .selector-slider {
        position: absolute;
        top: 4px;
        left: 4px;
        width: calc(50% - 4px);
        height: calc(100% - 8px);
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1;
        
        &::before {
          display: none;
        }
        
        &.slide-right {
          transform: translateX(calc(100% + 4px));
        }
      }
    }
  }
  
  .login-form {
    // æ‰‹æœºå·ç™»å½•è¡¨å•ï¼šéšè—é”™è¯¯æç¤º
    &.phone-login-form {
      :deep(.el-form-item__error) {
        display: none !important;
      }
    }
    
    // éªŒè¯ç è¾“å…¥æ¡†å®¹å™¨
    .captcha-input-wrapper {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      
      .el-input {
        flex: 1;
      }
      
      .captcha-button {
        white-space: nowrap;
        min-width: 120px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #fff;
        margin-top: 3px; // ç¨å¾®ä¸‹ç§»ä¸€ç‚¹
        
        &:hover:not(:disabled) {
          background: rgba(255, 255, 255, 0.15);
          border-color: rgba(255, 255, 255, 0.3);
        }
        
        &:disabled {
          color: #666;
          cursor: not-allowed;
        }
      }
    }
    
    :deep(.el-input) {
      .el-input__wrapper {
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 8px;
        transition: all 0.2s ease;
        outline: none !important;
        box-shadow: none !important;
        
        &:hover {
          border-color: rgba(255, 255, 255, 0.3);
          box-shadow: none !important;
        }
        
        &.is-focus {
          border-color: rgba(255, 255, 255, 0.3) !important;
          box-shadow: none !important;
          outline: none !important;
        }
        
        &:focus,
        &:focus-within,
        &:focus-visible {
          outline: none !important;
          box-shadow: none !important;
          border-color: rgba(255, 255, 255, 0.3) !important;
        }
      }
      
      .el-input__inner {
        color: #e0e0e0;
        font-size: 14px;
        padding: 0 12px;
        outline: none !important;
        border: none !important;
        box-shadow: none !important;
        
        &:focus,
        &:focus-visible,
        &:focus-within {
          outline: none !important;
          border: none !important;
          box-shadow: none !important;
        }
        
        &::placeholder {
          color: #666;
        }
      }
      
      .el-input__prefix {
        padding-left: 12px;
        
        .el-icon {
          color: #ffffff;
          font-size: 16px;
        }
      }
      
      // è¦†ç›–æ‰€æœ‰å¯èƒ½çš„ç„¦ç‚¹çŠ¶æ€ç»„åˆ
      &.is-focus .el-input__wrapper,
      &.is-focus .el-input__wrapper:hover {
        border-color: rgba(255, 255, 255, 0.3) !important;
        box-shadow: none !important;
        outline: none !important;
      }
    }
    
    // å…¨å±€ç§»é™¤è¾“å…¥æ¡†ç„¦ç‚¹å¤–è¾¹æ¡† - ä½¿ç”¨æ›´å…·ä½“çš„é€‰æ‹©å™¨è¦†ç›–æ‰€æœ‰å¯èƒ½çš„æƒ…å†µ
    :deep(.el-input__wrapper.is-focus),
    :deep(.el-input.is-focus .el-input__wrapper),
    :deep(.el-input .el-input__wrapper.is-focus),
    :deep(.el-form-item .el-input__wrapper.is-focus),
    :deep(.el-form-item .el-input.is-focus .el-input__wrapper),
    :deep(.el-input__wrapper.is-focus:hover),
    :deep(.el-input.is-focus .el-input__wrapper:hover) {
      box-shadow: none !important;
      outline: none !important;
      border-color: rgba(255, 255, 255, 0.3) !important;
    }
    
    :deep(input:focus),
    :deep(input:focus-visible),
    :deep(.el-input__inner:focus),
    :deep(.el-input__inner:focus-visible) {
      outline: none !important;
      box-shadow: none !important;
      border: none !important;
    }
    
    // ç§»é™¤æ‰€æœ‰å¯èƒ½çš„é˜´å½±æ•ˆæœï¼ŒåŒ…æ‹¬ inset box-shadow
    :deep(.el-input__wrapper) {
      box-shadow: none !important;
      
      &::before,
      &::after {
        box-shadow: none !important;
        outline: none !important;
      }
    }
    
    .login-options {
      margin-bottom: 24px;
      
      .options-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        width: 100%;
      }
    }
    
    :deep(.el-checkbox) {
      margin: 0;
      display: flex;
      align-items: center;
      
      .el-checkbox__input {
        display: flex;
        align-items: center;
        vertical-align: middle;
        
        .el-checkbox__inner {
          width: 18px;
          height: 18px;
          border: 2px solid rgba(255, 255, 255, 0.3);
          background: rgba(0, 0, 0, 0.2);
          border-radius: 4px;
          transition: all 0.3s ease;
          vertical-align: middle;
          
          &:hover {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.05);
          }
          
          &::after {
            border: 2px solid #ffffff;
            border-left: 0;
            border-top: 0;
            height: 10px;
              left: 50%;
              top: 50%;
            width: 5px;
              transition: all 0.2s ease;
              transform: translate(-50%, -50%) rotate(45deg) scale(0);
          }
        }
        
        &.is-checked {
          .el-checkbox__inner {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.8);
            box-shadow: 
              0 0 8px rgba(255, 255, 255, 0.3),
              inset 0 0 10px rgba(255, 255, 255, 0.1);
            
            &:hover {
              border-color: #ffffff;
              background: rgba(255, 255, 255, 0.2);
              box-shadow: 
                0 0 12px rgba(255, 255, 255, 0.4),
                inset 0 0 12px rgba(255, 255, 255, 0.15);
            }
          }
          
          &.is-checked .el-checkbox__inner::after {
            transform: translate(-50%, -50%) rotate(45deg) scale(1);
          }
        }
        
        &.is-focus {
          .el-checkbox__inner {
            border-color: rgba(255, 255, 255, 0.6);
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1);
          }
        }
      }
      
      .el-checkbox__label {
        color: #888;
        font-size: 14px;
        line-height: 1.5;
        padding-left: 8px;
        display: flex;
        align-items: center;
        vertical-align: middle;
      }
    }
    
    :deep(.forgot-password) {
      color: #ffffff !important;
      font-size: 14px;
      text-decoration: none;
      line-height: 1.5;
      white-space: nowrap;
      
      &:hover {
        color: #e0e0e0 !important;
        text-decoration: underline;
      }
    }
    
    .login-button {
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: #ffffff;
      font-weight: 600;
      height: 50px;
      border-radius: 12px;
      
      &:hover {
        background: rgba(255, 255, 255, 0.15);
      }
    }
  }
  
  .register-link {
    text-align: center;
    margin: 20px 0;
    
    .register-link-text {
      color: #ffffff;
      font-size: 14px;
    }
  }
  
  .login-footer {
    margin-top: 40px;
    padding-top: 30px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    
    .footer-info {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      font-size: 12px;
      
      .info-label {
        color: #888;
      }
      
      .info-value {
        color: #ffffff;
        
        &.status-green {
          color: #4ade80;
        }
      }
    }
    
    .footer-links {
      display: flex;
      gap: 16px;
      margin-top: 16px;
      flex-wrap: wrap;
      
      :deep(.el-link) {
        font-size: 11px;
        color: #666;
        
        &:hover {
          color: #ffffff;
        }
      }
    }
  }
  
  .login-bg-decoration {
    display: none;
  }
}

@keyframes rotateCube {
  0% { transform: rotateX(0deg) rotateY(0deg); }
  100% { transform: rotateX(360deg) rotateY(360deg); }
}

@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-20px); }
}

// å“åº”å¼è®¾è®¡
@media (max-width: 1024px) {
  .login-page {
    flex-direction: column;
  }
  
  .dashboard-section,
  .login-section {
    flex: 0 0 50%;
  }
}

@media (max-width: 768px) {
  .dashboard-section {
    display: none;
  }
  
  .login-section {
    flex: 0 0 100%;
  }
}

// å¯¹è¯æ¡†æ ·å¼
.about-content,
.contact-content {
  color: #e0e0e0;
  line-height: 1.8;
  
  h3 {
    font-size: 20px;
    font-weight: 600;
    color: #ffffff;
    margin-bottom: 16px;
    text-align: center;
  }
  
  h4 {
    font-size: 16px;
    font-weight: 600;
    color: #ffffff;
    margin-top: 20px;
    margin-bottom: 12px;
    
    &:first-of-type {
      margin-top: 0;
    }
  }
  
  p {
    font-size: 14px;
    color: #aaa;
    margin-bottom: 12px;
    text-align: justify;
  }
  
  ul {
    margin: 12px 0;
    padding-left: 24px;
    
    li {
      font-size: 14px;
      color: #aaa;
      margin-bottom: 8px;
    }
  }
  
  .contact-item {
    margin-bottom: 16px;
    padding: 12px;
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    
    strong {
      color: #ffffff;
      display: block;
      margin-bottom: 6px;
    }
    
    span, a {
      color: #aaa;
      font-size: 14px;
    }
    
    a {
      color: #ffffff;
      text-decoration: none;
      
      &:hover {
        color: #e0e0e0;
        text-shadow: none;
      }
    }
  }
}

// å¯¹è¯æ¡†æ·±è‰²ä¸»é¢˜
:deep(.el-dialog) {
  background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
  border: 1px solid rgba(255, 255, 255, 0.1);
  
  .el-dialog__header {
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    padding: 20px;
    background: transparent !important;
    
    .el-dialog__title {
      color: #ffffff;
      font-weight: 600;
    }
    
    .el-dialog__headerbtn {
      .el-dialog__close {
        color: #888;
        
        &:hover {
          color: #ffffff;
        }
      }
    }
  }
  
  .el-dialog__body {
    color: #e0e0e0;
    padding: 20px;
    background: transparent !important;
  }
  
  .el-dialog__footer {
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    padding: 20px;
    background: transparent !important;
    
    .el-button {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #ffffff;
        
        &:hover {
          background: rgba(255, 255, 255, 0.15);
        }
    }
  }
}

// å…¨å±€ç§»é™¤æ‰€æœ‰è¾“å…¥æ¡†çš„ç„¦ç‚¹å¤–è¾¹æ¡† - ä½¿ç”¨æœ€é«˜ä¼˜å…ˆçº§çš„é€‰æ‹©å™¨
.login-page {
  // è¦†ç›–æ‰€æœ‰å¯èƒ½çš„ Element Plus è¾“å…¥æ¡†ç„¦ç‚¹æ ·å¼
  :deep(.el-input__wrapper) {
    box-shadow: none !important;
    
    &.is-focus,
    &.is-focus:hover {
      box-shadow: none !important;
      outline: none !important;
      border-color: rgba(255, 255, 255, 0.3) !important;
    }
  }
  
  :deep(.el-input.is-focus .el-input__wrapper),
  :deep(.el-input .el-input__wrapper.is-focus),
  :deep(.el-input.is-focus .el-input__wrapper:hover),
  :deep(.el-form-item .el-input__wrapper.is-focus),
  :deep(.el-form-item .el-input.is-focus .el-input__wrapper),
  :deep(.login-form .el-input__wrapper.is-focus),
  :deep(.login-form .el-input.is-focus .el-input__wrapper) {
    box-shadow: none !important;
    outline: none !important;
    border-color: rgba(255, 255, 255, 0.3) !important;
  }
  
  :deep(.el-input__inner) {
    &:focus,
    &:focus-visible,
    &:focus-within {
      outline: none !important;
      box-shadow: none !important;
      border: none !important;
    }
  }
  
  // ç§»é™¤æ‰€æœ‰å¯èƒ½çš„ä¼ªå…ƒç´ é˜´å½±
  :deep(.el-input__wrapper::before),
  :deep(.el-input__wrapper::after) {
    box-shadow: none !important;
    outline: none !important;
  }
  
  // è¦†ç›– CSS å˜é‡ï¼ˆElement Plus å¯èƒ½ä½¿ç”¨å˜é‡æ¥æ§åˆ¶ç„¦ç‚¹é¢œè‰²ï¼‰
  :deep(.el-input__wrapper.is-focus) {
    --el-input-focus-border-color: rgba(255, 255, 255, 0.3) !important;
    --el-color-primary: rgba(255, 255, 255, 0.3) !important;
  }
  
  // æœ€æ¿€è¿›çš„è¦†ç›– - é’ˆå¯¹æ‰€æœ‰å¯èƒ½çš„ç»„åˆ
  :deep(*) {
    &.el-input__wrapper.is-focus,
    &.el-input.is-focus .el-input__wrapper {
      box-shadow: none !important;
      outline: none !important;
    }
  }
}
</style>





















