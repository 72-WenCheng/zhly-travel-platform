# 手机号登录功能使用说明

## 功能概述

已实现完整的手机号验证码登录和注册功能，支持各地区手机号格式。

## 数据库初始化

### 执行SQL文件
```bash
# 在MySQL中执行
source travel-server/docs/sql/phone_login.sql
```

或者直接执行SQL：
```sql
-- 添加phone字段
ALTER TABLE sys_user 
ADD COLUMN IF NOT EXISTS phone VARCHAR(20) COMMENT '手机号' AFTER email;

-- 添加唯一索引
ALTER TABLE sys_user DROP INDEX IF EXISTS uk_phone;
ALTER TABLE sys_user ADD UNIQUE INDEX uk_phone (phone);

-- 添加普通索引
ALTER TABLE sys_user DROP INDEX IF EXISTS idx_phone;
ALTER TABLE sys_user ADD INDEX idx_phone (phone);
```

## API接口说明

### 1. 发送手机验证码
**接口：** `POST /api/auth/send-phone-captcha`

**请求体：**
```json
{
  "phone": "13800138000"
}
```

**响应：**
```json
{
  "code": 200,
  "message": "验证码已发送",
  "data": null
}
```

**说明：**
- 验证码有效期：5分钟
- 目前是模拟发送（控制台打印），生产环境需要集成短信服务
- 验证码格式：6位数字

### 2. 手机号注册
**接口：** `POST /api/auth/register/phone`

**请求体：**
```json
{
  "phone": "13800138000",
  "captcha": "123456",
  "password": "password123",
  "inviteCode": "optional"
}
```

**响应：**
```json
{
  "code": 200,
  "message": "注册成功",
  "data": null
}
```

**说明：**
- 手机号会自动格式化和验证
- 密码需要符合强度要求（至少包含字母和数字）
- 如果手机号已注册，会提示"该手机号已被注册，请直接登录"
- 注册成功后，默认用户名为 `user_手机号后8位`，昵称为 `用户手机号后4位`

### 3. 手机号登录
**接口：** `POST /api/auth/login/phone`

**请求体：**
```json
{
  "phone": "13800138000",
  "captcha": "123456",
  "loginType": "user"
}
```

**响应：**
```json
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "user": {
      "id": 1,
      "username": "user_00138000",
      "nickname": "用户8000",
      "phone": "13800138000",
      ...
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "expiresIn": 1440
  }
}
```

**说明：**
- `loginType`: "user" 表示用户端登录，"admin" 表示管理端登录
- 如果手机号未注册，会提示"该手机号未注册，请先注册"
- 验证码验证成功后会自动失效（一次性使用）

## 支持的手机号格式

### 中国大陆
- 格式：`1[3-9]xxxxxxxxx`
- 示例：`13800138000`, `15912345678`

### 中国香港
- 格式：`(5|6|9)xxxxxxx`
- 示例：`51234567`, `61234567`, `91234567`

### 中国台湾
- 格式：`09xxxxxxxx`
- 示例：`0912345678`

### 国际格式
- 格式：`+国家代码+号码`
- 示例：`+8613800138000`, `+14155552671`

### 其他支持地区
- 美国/加拿大：`+1xxxxxxxxxx`
- 英国：`+44xxxxxxxxxx`
- 日本：`+81xxxxxxxxxx`
- 韩国：`+82xxxxxxxxxx`
- 新加坡：`+65xxxxxxxxx`
- 等20+个地区

## 前端集成示例

### Vue 3 + TypeScript

```typescript
import { authAPI } from '@/api/auth'

// 发送验证码
const sendPhoneCaptcha = async (phone: string) => {
  try {
    const response = await authAPI.sendPhoneCaptcha({ phone })
    if (response.code === 200) {
      ElMessage.success('验证码已发送')
      // 开始倒计时
      startCountdown()
    }
  } catch (error: any) {
    ElMessage.error(error.response?.data?.message || '发送验证码失败')
  }
}

// 手机号注册
const registerByPhone = async (phone: string, captcha: string, password: string) => {
  try {
    const response = await authAPI.registerByPhone({
      phone,
      captcha,
      password
    })
    if (response.code === 200) {
      ElMessage.success('注册成功，请登录')
      router.push('/login')
    }
  } catch (error: any) {
    ElMessage.error(error.response?.data?.message || '注册失败')
  }
}

// 手机号登录
const loginByPhone = async (phone: string, captcha: string, loginType: string = 'user') => {
  try {
    const response = await authAPI.loginByPhone({
      phone,
      captcha,
      loginType
    })
    if (response.code === 200) {
      // 保存token和用户信息
      localStorage.setItem('token', response.data.token)
      localStorage.setItem('userInfo', JSON.stringify(response.data.user))
      ElMessage.success('登录成功')
      router.push('/home')
    }
  } catch (error: any) {
    ElMessage.error(error.response?.data?.message || '登录失败')
  }
}
```

### API定义（auth.ts）

```typescript
// 发送手机验证码
export const sendPhoneCaptcha = (data: { phone: string }) => {
  return request.post('/auth/send-phone-captcha', data)
}

// 手机号注册
export const registerByPhone = (data: {
  phone: string
  captcha: string
  password: string
  inviteCode?: string
}) => {
  return request.post('/auth/register/phone', data)
}

// 手机号登录
export const loginByPhone = (data: {
  phone: string
  captcha: string
  loginType?: string
}) => {
  return request.post('/auth/login/phone', data)
}
```

## 注意事项

1. **验证码发送**：目前是模拟发送（控制台打印），生产环境需要集成短信服务
2. **验证码有效期**：5分钟，过期后需要重新获取
3. **验证码使用**：验证码验证成功后会自动失效，不能重复使用
4. **手机号唯一性**：每个手机号只能注册一个账号
5. **频率限制**：建议添加发送频率限制，防止恶意刷取验证码
6. **安全性**：建议添加图形验证码，防止机器人攻击

## 短信服务集成（生产环境）

### 推荐服务商
1. **阿里云短信服务**
2. **腾讯云短信服务**
3. **华为云短信服务**

### 集成步骤
1. 在对应服务商平台创建应用，获取 AccessKey 和 SecretKey
2. 在 `application.yml` 中配置短信服务参数
3. 在 `UserServiceImpl.sendPhoneCaptcha` 方法中替换模拟发送代码为实际短信发送代码

## 测试建议

1. **功能测试**
   - 测试发送验证码
   - 测试手机号注册
   - 测试手机号登录
   - 测试验证码过期
   - 测试错误验证码

2. **边界测试**
   - 测试各种手机号格式
   - 测试已注册手机号重复注册
   - 测试未注册手机号登录
   - 测试空值和异常值

3. **性能测试**
   - 测试并发发送验证码
   - 测试大量用户注册登录









