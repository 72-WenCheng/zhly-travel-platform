# 阿里云短信服务配置说明

## 一、开通阿里云短信服务

### 1. 注册阿里云账号
访问 [阿里云官网](https://www.aliyun.com/) 注册账号

### 2. 开通短信服务
1. 登录阿里云控制台
2. 进入 **产品与服务** → **短信服务**
3. 开通短信服务（首次使用需要实名认证）

### 3. 创建AccessKey
1. 进入 **AccessKey管理** 页面
2. 创建AccessKey，获取：
   - **AccessKey ID**
   - **AccessKey Secret**
3. ⚠️ **重要**：妥善保管AccessKey Secret，不要泄露

### 4. 申请短信签名
1. 进入 **短信服务** → **国内消息** → **签名管理**
2. 点击 **添加签名**
3. 填写签名信息：
   - 签名名称：`智慧生态旅游平台`（或您自己的签名）
   - 签名来源：选择 **企事业单位全称或简称**
   - 上传营业执照等证明材料
4. 等待审核通过（通常1-2个工作日）

### 5. 申请短信模板
1. 进入 **短信服务** → **国内消息** → **模板管理**
2. 点击 **添加模板**
3. 填写模板信息：
   - 模板名称：验证码模板
   - 模板类型：验证码
   - 模板内容：`您的验证码是${code}，5分钟内有效，请勿泄露给他人。`
   - 说明：用于用户注册和登录验证
4. 等待审核通过（通常1-2个工作日）
5. 审核通过后，获取 **模板代码**（TemplateCode）

## 二、配置系统

### 方式一：使用环境变量（推荐）

在系统环境变量中设置：

**Windows (PowerShell):**
```powershell
$env:ALIYUN_SMS_ACCESS_KEY_ID="your-access-key-id"
$env:ALIYUN_SMS_ACCESS_KEY_SECRET="your-access-key-secret"
$env:ALIYUN_SMS_TEMPLATE_CODE="SMS_123456789"
```

**Windows (CMD):**
```cmd
set ALIYUN_SMS_ACCESS_KEY_ID=your-access-key-id
set ALIYUN_SMS_ACCESS_KEY_SECRET=your-access-key-secret
set ALIYUN_SMS_TEMPLATE_CODE=SMS_123456789
```

**Linux/Mac:**
```bash
export ALIYUN_SMS_ACCESS_KEY_ID="your-access-key-id"
export ALIYUN_SMS_ACCESS_KEY_SECRET="your-access-key-secret"
export ALIYUN_SMS_TEMPLATE_CODE="SMS_123456789"
```

### 方式二：直接修改配置文件

编辑 `travel-server/src/main/resources/application-dev.yml`：

```yaml
aliyun:
  sms:
    enabled: true
    access-key-id: your-access-key-id  # 替换为您的AccessKey ID
    access-key-secret: your-access-key-secret  # 替换为您的AccessKey Secret
    sign-name: 智慧生态旅游平台  # 替换为您审核通过的签名
    template-code: SMS_123456789  # 替换为您审核通过的模板代码
```

⚠️ **注意**：直接写在配置文件中存在安全风险，建议使用环境变量。

## 三、短信模板示例

### 验证码模板
**模板内容：**
```
您的验证码是${code}，5分钟内有效，请勿泄露给他人。
```

**模板代码格式：** `SMS_123456789`

### 模板变量说明
- `${code}`：验证码变量，系统会自动替换为6位数字验证码

## 四、测试短信发送

### 1. 启动应用
```bash
cd travel-server
mvn spring-boot:run
```

### 2. 测试发送验证码
使用Postman或前端页面测试：
```bash
POST http://localhost:8070/api/auth/send-phone-captcha
Content-Type: application/json

{
  "phone": "13800138000"
}
```

### 3. 查看日志
- 如果配置正确，会看到 "短信发送成功" 的日志
- 如果配置错误，会看到错误信息，并自动降级为模拟发送

## 五、费用说明

### 阿里云短信服务计费
- **按量付费**：0.045元/条（国内短信）
- **套餐包**：购买套餐包更优惠
- **免费额度**：新用户通常有免费额度

### 成本控制建议
1. 设置发送频率限制（防止恶意刷取）
2. 验证码有效期设置合理（5分钟）
3. 生产环境建议购买套餐包

## 六、常见问题

### 1. 短信发送失败
**可能原因：**
- AccessKey配置错误
- 签名未审核通过
- 模板未审核通过
- 账户余额不足
- 手机号格式不正确

**解决方法：**
- 检查配置是否正确
- 查看控制台日志错误信息
- 确认签名和模板审核状态
- 检查账户余额

### 2. 短信未收到
**可能原因：**
- 手机号格式错误
- 手机号被运营商拦截
- 短信服务商延迟

**解决方法：**
- 检查手机号格式
- 查看短信服务控制台的发送记录
- 联系阿里云客服

### 3. 开发环境不想发送真实短信
**解决方法：**
在 `application-dev.yml` 中设置：
```yaml
aliyun:
  sms:
    enabled: false  # 禁用短信服务，使用模拟发送
```

## 七、安全建议

1. **不要将AccessKey提交到代码仓库**
   - 使用环境变量或配置中心
   - 将配置文件添加到 `.gitignore`

2. **定期更换AccessKey**
   - 建议每3-6个月更换一次

3. **设置IP白名单**
   - 在阿里云控制台设置API调用IP白名单

4. **启用短信发送频率限制**
   - 防止恶意刷取验证码
   - 建议：同一手机号1分钟内最多发送1条

## 八、其他短信服务商

如果不想使用阿里云，也可以集成其他服务商：

### 腾讯云短信
- 访问：https://cloud.tencent.com/product/sms
- SDK：`tencentcloud-sdk-java`

### 华为云短信
- 访问：https://www.huaweicloud.com/product/msgsms.html
- SDK：`huaweicloud-sdk-sms`

### 容联云短信
- 访问：https://www.yuntongxun.com/
- SDK：`ronglian-sms-sdk`

## 九、配置检查清单

- [ ] 已注册阿里云账号
- [ ] 已开通短信服务
- [ ] 已创建AccessKey
- [ ] 已申请短信签名（审核通过）
- [ ] 已申请短信模板（审核通过）
- [ ] 已配置AccessKey ID
- [ ] 已配置AccessKey Secret
- [ ] 已配置短信签名
- [ ] 已配置模板代码
- [ ] 已测试发送短信
- [ ] 账户有足够余额









