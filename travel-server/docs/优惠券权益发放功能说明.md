# 优惠券权益发放功能说明

## 功能概述

根据用户等级自动发放优惠券，是等级体系的重要权益之一。只有黄金游侠及以上等级的用户才能获得优惠券。

## 等级与优惠券对应关系

| 等级 | 等级代码 | 每月优惠券数量 | 优惠券类型 |
|------|---------|--------------|-----------|
| 黄金游侠 | 3 | 1张 | 满50减10 |
| 铂金旅者 | 4 | 2张 | 满100减20 |
| 钻石达人 | 5 | 3张 | 满200减50 |
| 王者导师 | 6 | 5张 | 满300减100 |

## 发放时机

### 1. 每月自动发放
- **触发时间**: 每月1号凌晨4点
- **实现方式**: 定时任务 `ScheduledTasks.distributeMonthlyCoupons()`
- **发放对象**: 所有达到黄金游侠及以上等级的用户
- **防重复**: 检查本月是否已发放，避免重复发放

### 2. 等级提升时自动发放
- **触发时机**: 用户积分增加导致等级提升时
- **实现位置**: `UserPointsServiceImpl.addPoints()`
- **发放对象**: 升级到黄金游侠及以上等级的用户
- **发放数量**: 根据新等级对应的数量发放

### 3. 手动触发发放
- **API接口**: `POST /api/user/points/distribute-coupons?userId={userId}`
- **用途**: 测试、管理员操作、补发等
- **限制**: 只有黄金游侠及以上等级才能发放

## 数据库表结构

### user_coupon 表
```sql
CREATE TABLE `user_coupon` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT,
  `user_id` BIGINT(20) NOT NULL COMMENT '用户ID',
  `coupon_id` BIGINT(20) NOT NULL COMMENT '优惠券ID',
  `coupon_name` VARCHAR(100) DEFAULT NULL COMMENT '优惠券名称',
  `coupon_type` INT(11) DEFAULT NULL COMMENT '优惠券类型',
  `discount_value` DECIMAL(10,2) DEFAULT NULL COMMENT '优惠金额',
  `min_amount` DECIMAL(10,2) DEFAULT NULL COMMENT '最低使用金额',
  `source_type` INT(11) DEFAULT 1 COMMENT '来源类型（1-等级权益自动发放）',
  `source_desc` VARCHAR(200) DEFAULT NULL COMMENT '来源描述',
  `status` INT(11) DEFAULT 1 COMMENT '状态（1-未使用 2-已使用 3-已过期）',
  `valid_start_time` DATETIME DEFAULT NULL COMMENT '有效期开始时间',
  `valid_end_time` DATETIME DEFAULT NULL COMMENT '有效期结束时间',
  `used_time` DATETIME DEFAULT NULL COMMENT '使用时间',
  `order_id` BIGINT(20) DEFAULT NULL COMMENT '使用的订单ID',
  `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `update_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

## 核心代码文件

1. **实体类**: `UserCoupon.java`
2. **Mapper**: `UserCouponMapper.java`
3. **服务接口**: `ICouponDistributionService.java`
4. **服务实现**: `CouponDistributionServiceImpl.java`
5. **定时任务**: `ScheduledTasks.java`
6. **控制器**: `UserPointsController.java`

## 使用示例

### 手动触发发放
```bash
POST /api/user/points/distribute-coupons?userId=123
```

### 查询用户优惠券
```sql
SELECT * FROM user_coupon 
WHERE user_id = 123 
AND status = 1 
AND valid_end_time >= NOW();
```

## 注意事项

1. **防重复发放**: 系统会检查本月是否已发放，避免重复发放
2. **有效期**: 优惠券有效期为30天，从发放时开始计算
3. **等级要求**: 只有黄金游侠及以上等级才能获得优惠券
4. **自动创建模板**: 如果优惠券模板不存在，系统会自动创建
5. **事务保证**: 所有发放操作都在事务中执行，确保数据一致性

## 后续优化建议

1. 添加优惠券使用统计
2. 添加优惠券过期提醒
3. 支持自定义优惠券模板
4. 添加优惠券使用记录查询接口









