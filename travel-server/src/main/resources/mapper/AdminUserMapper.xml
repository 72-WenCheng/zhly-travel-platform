<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zhly.admin.mapper.AdminUserMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.zhly.admin.entity.AdminUser">
        <id column="id" property="id" />
        <result column="username" property="username" />
        <result column="password" property="password" />
        <result column="nickname" property="nickname" />
        <result column="email" property="email" />
        <result column="phone" property="phone" />
        <!-- user_type 字段已移除，不再映射 -->
        <result column="role" property="role" />
        <result column="travel_preference" property="travelPreference" />
        <result column="status" property="status" />
        <result column="create_time" property="createTime" />
        <result column="update_time" property="updateTime" />
        <result column="last_login_ip" property="lastLoginIp" />
        <result column="last_login_time" property="lastLoginTime" />
        <result column="avatar" property="avatar" />
        <!-- points 和 level 字段已移除，不再映射，从 user_points 表获取 -->
        <!-- interest_tags 和 frequent_cities 字段已移除，不再映射，从用户画像服务获取 -->
        <result column="deleted" property="deleted" />
    </resultMap>

    <!-- 获取用户列表（带分页和搜索） -->
    <select id="selectUserList" resultMap="BaseResultMap">
        SELECT 
            id, username, password, nickname, email, phone, role, travel_preference, 
            status, create_time, update_time, last_login_ip, last_login_time, avatar,
            deleted
        FROM sys_user
        <where>
            deleted = 0
            <if test="keyword != null and keyword != ''">
                AND (username LIKE CONCAT('%', #{keyword}, '%') 
                     OR nickname LIKE CONCAT('%', #{keyword}, '%')
                     OR email LIKE CONCAT('%', #{keyword}, '%')
                     OR phone LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </where>
        ORDER BY create_time DESC
        LIMIT ${(page - 1) * size}, #{size}
    </select>

    <!-- 获取用户总数 -->
    <select id="selectUserCount" resultType="java.lang.Long">
        SELECT COUNT(*) FROM sys_user
        <where>
            deleted = 0
            <if test="keyword != null and keyword != ''">
                AND (username LIKE CONCAT('%', #{keyword}, '%') 
                     OR nickname LIKE CONCAT('%', #{keyword}, '%')
                     OR email LIKE CONCAT('%', #{keyword}, '%')
                     OR phone LIKE CONCAT('%', #{keyword}, '%'))
            </if>
        </where>
    </select>

    <!-- 批量更新用户状态 -->
    <update id="batchUpdateStatus">
        UPDATE sys_user 
        SET status = #{status}, update_time = NOW()
        WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 获取用户统计信息 -->
    <select id="selectUserStatistics" resultType="java.util.Map">
        SELECT 
            COUNT(*) as total,
            COUNT(CASE WHEN status = 1 THEN 1 END) as active,
            COUNT(CASE WHEN status = 0 THEN 1 END) as inactive,
            COUNT(CASE WHEN create_time >= DATE_SUB(NOW(), INTERVAL 7 DAY) THEN 1 END) as newUsers,
            COUNT(CASE WHEN create_time >= DATE_SUB(NOW(), INTERVAL 30 DAY) THEN 1 END) as monthlyUsers
        FROM sys_user
        WHERE deleted = 0
    </select>

    <!-- 获取用户列表（用于导出，不分页） -->
    <select id="selectUserListForExport" resultMap="BaseResultMap">
        SELECT 
            id, username, password, nickname, email, phone, role, travel_preference, 
            status, create_time, update_time, last_login_ip, last_login_time, avatar,
            deleted
        FROM sys_user
        <where>
            deleted = 0
            <if test="keyword != null and keyword != ''">
                AND (username LIKE CONCAT('%', #{keyword}, '%') 
                     OR nickname LIKE CONCAT('%', #{keyword}, '%')
                     OR email LIKE CONCAT('%', #{keyword}, '%')
                     OR phone LIKE CONCAT('%', #{keyword}, '%'))
            </if>
            <!-- user_type 字段已移除，不再支持按 user_type 筛选 -->
            <if test="role != null">
                AND role = #{role}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
        ORDER BY create_time DESC
    </select>

</mapper>

