# 登录状态和会话管理说明

## 📋 你的问题

1. 直接关闭浏览器标签页，是否会被记录为退出登录？
2. 需要按退出登录按钮才会被标记为退出登录？
3. 多长时间会被标记为退出登录？
4. 是否与会话（session）有关？

---

## 🔍 当前系统的机制

### 1. 关闭标签页的处理

#### 当前实现

```javascript
// App.vue 中的处理
window.addEventListener('beforeunload', handleBeforeUnload)

// 尝试在窗口关闭时发送退出登录请求
const sendLogoutRequest = () => {
  fetch('/api/user/logout', {
    method: 'POST',
    keepalive: true  // 关键：确保请求在页面关闭后也能完成
  })
}
```

#### 实际情况

**❌ 不是100%可靠**

原因：
- 浏览器可能不允许在关闭时发送请求
- 网络延迟可能导致请求未完成
- 某些浏览器会限制 `beforeunload` 事件的处理时间

**结果：**
- 大多数情况下，直接关闭标签页**不会**被记录为退出登录
- 后端可能不知道用户已关闭页面
- Token 仍然有效，直到过期

---

### 2. 手动退出登录

#### 流程

```
用户点击"退出登录"
    ↓
调用 userStore.logout()
    ↓
1. 调用后端API: POST /api/user/logout
2. 清除本地存储（sessionStorage + localStorage）
3. 跳转到登录页
```

#### 特点

**✅ 100%可靠**

- 后端会收到退出登录请求
- 用户状态会被正确标记为离线
- 本地存储会被清除

---

### 3. 会话超时机制

#### 配置说明

```yaml
# 系统配置（可配置）
security.session.timeout: 120  # 默认120分钟（2小时）

# JWT Token过期时间（固定）
travel.jwt.expiration: 86400000  # 24小时（毫秒）
```

#### 实际使用

```
登录时：
1. 获取系统配置的 sessionTimeout（默认120分钟）
2. 生成JWT Token，有效期 = sessionTimeout
3. Token过期后，后端会拒绝请求
```

#### 超时后的行为

```
Token过期
    ↓
后端返回 401（未授权）
    ↓
前端拦截器检测到401
    ↓
提示"登录状态已失效，请重新登录"
    ↓
清除本地存储
    ↓
跳转到登录页
```

---

## ⏰ 时间线说明

### 场景1：正常使用

```
登录成功
    ↓
Token有效期：120分钟（可配置）
    ↓
120分钟内正常使用
    ↓
120分钟后Token过期
    ↓
下次请求时返回401
    ↓
自动跳转到登录页
```

### 场景2：直接关闭标签页

```
用户关闭标签页
    ↓
尝试发送退出登录请求（可能失败）
    ↓
后端可能不知道用户已关闭
    ↓
Token仍然有效（直到120分钟过期）
    ↓
120分钟后Token过期
    ↓
下次访问时需重新登录
```

### 场景3：手动退出登录

```
用户点击"退出登录"
    ↓
后端收到退出请求 ✅
    ↓
清除本地存储 ✅
    ↓
立即跳转到登录页 ✅
    ↓
Token立即失效
```

---

## 🔐 存储机制

### sessionStorage vs localStorage

```javascript
// sessionStorage（标签页级别）
- 关闭标签页时自动清除
- 刷新页面时保留
- 每个标签页独立

// localStorage（浏览器级别）
- 关闭浏览器后仍然保留
- 需要手动清除
- 所有标签页共享
```

### 当前实现

```javascript
// 登录时
sessionStorage.setItem('travel_token', token)
sessionStorage.setItem('travel_user_info', userInfo)
localStorage.setItem('travel_token', token)  // 兼容旧版本
localStorage.setItem('travel_user_info', userInfo)

// 退出时
sessionStorage.removeItem('travel_token')
sessionStorage.removeItem('travel_user_info')
localStorage.removeItem('travel_token')
localStorage.removeItem('travel_user_info')
```

---

## 📊 总结对比

| 场景 | 后端是否知道 | Token状态 | 需要重新登录 |
|------|------------|----------|------------|
| **手动退出** | ✅ 知道 | 立即失效 | 立即需要 |
| **关闭标签页** | ❌ 可能不知道 | 仍然有效 | 120分钟后 |
| **Token过期** | ✅ 知道 | 已失效 | 立即需要 |
| **关闭浏览器** | ❌ 不知道 | 仍然有效 | 120分钟后 |

---

## 💡 建议改进

### 方案1：心跳机制（推荐）

```javascript
// 定期发送心跳，告诉后端用户还在线
setInterval(() => {
  if (userStore.isLoggedIn) {
    request.post('/api/user/heartbeat')
  }
}, 5 * 60 * 1000)  // 每5分钟发送一次

// 后端：如果5分钟内没有心跳，标记为离线
```

### 方案2：页面可见性检测

```javascript
// 当页面隐藏时，标记为可能离线
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    // 标记为可能离线
  } else {
    // 页面可见，发送心跳确认在线
  }
})
```

### 方案3：缩短Token有效期

```yaml
# 将Token有效期缩短到30分钟
security.session.timeout: 30  # 30分钟
```

---

## 🎯 回答你的问题

### Q1: 直接关闭标签页，是否会被记录为退出登录？

**A: 不一定**

- 系统会**尝试**发送退出登录请求
- 但浏览器可能不允许，所以**大多数情况下不会**
- 后端可能不知道用户已关闭页面
- Token仍然有效，直到过期（默认120分钟）

### Q2: 需要按退出登录按钮才会被标记为退出登录？

**A: 是的**

- 只有点击"退出登录"按钮，才会**100%可靠**地标记为退出
- 后端会收到退出请求
- 用户状态会被正确更新

### Q3: 多长时间会被标记为退出登录？

**A: 120分钟（可配置）**

- 默认会话超时：**120分钟（2小时）**
- Token过期后，下次请求时会提示重新登录
- 可以在系统设置中修改这个时间

### Q4: 是否与会话（session）有关？

**A: 是的，但使用的是JWT Token**

- 系统使用**JWT Token**机制，不是传统的Session
- Token有过期时间（默认120分钟）
- Token过期后需要重新登录
- 使用 `sessionStorage` 存储（标签页级别）

---

## 📝 配置说明

### 修改会话超时时间

1. **系统设置中修改**（推荐）
   - 登录管理平台
   - 进入"系统设置"
   - 修改"会话超时"配置（单位：分钟）

2. **配置文件修改**
   ```yaml
   # application.yml
   security:
     session:
       timeout: 120  # 修改为你想要的时间（分钟）
   ```

### 当前默认值

- **会话超时**：120分钟（2小时）
- **JWT Token过期**：24小时（但实际使用会话超时时间）
- **心跳间隔**：未实现（建议添加）

---

## 🔧 技术细节

### JWT Token结构

```
Header（头部）
├── alg: HS256
└── typ: JWT

Payload（载荷）
├── userId: 用户ID
├── username: 用户名
├── iat: 签发时间
└── exp: 过期时间（当前时间 + 120分钟）

Signature（签名）
└── 使用密钥签名
```

### Token验证流程

```
1. 前端发送请求，携带Token
2. 后端验证Token签名
3. 检查Token是否过期
4. 如果过期，返回401
5. 前端收到401，清除存储，跳转登录
```

---

**总结：直接关闭标签页通常不会被记录为退出登录，需要等待Token过期（默认120分钟）或手动点击退出登录按钮。**





